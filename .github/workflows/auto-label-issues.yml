name: è‡ªåŠ¨æ ‡è®°å’Œåˆ†ç±» Issue

on:
  issues:
    types: [opened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: è‡ªåŠ¨åˆ†ç±»å’Œæ·»åŠ æ ‡ç­¾
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const labels = [];

            console.log(`ğŸ“‹ å¤„ç† Issue #${issue.number}: ${issue.title}`);

            // 1. æ ¹æ®æ ‡é¢˜å‰ç¼€è‡ªåŠ¨åˆ†ç±»
            if (title.startsWith('[bug]') || title.startsWith('[é”™è¯¯]')) {
              labels.push('bug');
              console.log('  ğŸ› æ£€æµ‹åˆ° Bug ç±»å‹');
            }
            
            if (title.startsWith('[feature]') || title.startsWith('[åŠŸèƒ½]') || title.startsWith('[éœ€æ±‚]')) {
              labels.push('enhancement');
              console.log('  âœ¨ æ£€æµ‹åˆ°åŠŸèƒ½éœ€æ±‚ç±»å‹');
            }

            if (title.startsWith('[docs]') || title.startsWith('[æ–‡æ¡£]')) {
              labels.push('documentation');
              console.log('  ğŸ“š æ£€æµ‹åˆ°æ–‡æ¡£ç±»å‹');
            }

            if (title.startsWith('[question]') || title.startsWith('[é—®é¢˜]')) {
              labels.push('question');
              console.log('  â“ æ£€æµ‹åˆ°é—®é¢˜ç±»å‹');
            }

            // 2. æ ¹æ®å†…å®¹å…³é”®è¯æ™ºèƒ½åˆ†ç±»
            const keywords = {
              bug: ['æŠ¥é”™', 'é”™è¯¯', 'å¼‚å¸¸', 'error', 'bug', 'å´©æºƒ', 'crash', 'å¤±è´¥', 'fail', 'ä¸å·¥ä½œ', 'not work'],
              enhancement: ['å»ºè®®', 'å¸Œæœ›', 'èƒ½å¦', 'å¢åŠ ', 'æ·»åŠ ', 'feature', 'enhancement', 'ä¼˜åŒ–', 'optimize', 'æ”¹è¿›', 'improve'],
              documentation: ['æ–‡æ¡£', 'è¯´æ˜', 'æ•™ç¨‹', 'document', 'readme', 'guide', 'å¦‚ä½•', 'how to'],
              question: ['æ€ä¹ˆ', 'å¦‚ä½•', 'ä¸ºä»€ä¹ˆ', 'how', 'why', 'what', 'æ˜¯ä»€ä¹ˆ', 'è¯·é—®'],
              performance: ['æ€§èƒ½', 'æ…¢', 'å¡é¡¿', 'performance', 'slow', 'å»¶è¿Ÿ', 'latency'],
              security: ['å®‰å…¨', 'æ¼æ´', 'security', 'vulnerability', 'æƒé™', 'permission'],
              ui: ['ç•Œé¢', 'æ˜¾ç¤º', 'ui', 'ux', 'æ ·å¼', 'style', 'å¸ƒå±€', 'layout'],
              api: ['api', 'æ¥å£', 'endpoint', 'è°ƒç”¨'],
              database: ['æ•°æ®åº“', 'database', 'sql', 'å­˜å‚¨', 'storage'],
              memory: ['è®°å¿†', 'é—å¿˜', 'å¬å›', 'memory', 'recall', 'æ£€ç´¢', 'retrieval'],
              config: ['é…ç½®', 'config', 'setting', 'è®¾ç½®'],
            };

            for (const [label, words] of Object.entries(keywords)) {
              for (const word of words) {
                if (title.includes(word) || body.includes(word)) {
                  if (!labels.includes(label)) {
                    labels.push(label);
                    console.log(`  ğŸ·ï¸  æ ¹æ®å…³é”®è¯ "${word}" æ·»åŠ æ ‡ç­¾: ${label}`);
                  }
                  break;
                }
              }
            }

            // 3. ä¼˜å…ˆçº§æ£€æµ‹
            const priorityKeywords = {
              'priority: high': ['ç´§æ€¥', 'urgent', 'ä¸¥é‡', 'critical', 'é‡å¤§', 'é˜»å¡', 'blocking'],
              'priority: medium': ['é‡è¦', 'important', 'å½±å“', 'impact'],
              'priority: low': ['å¯é€‰', 'optional', 'å»ºè®®', 'suggestion', 'å°†æ¥', 'future']
            };

            for (const [label, words] of Object.entries(priorityKeywords)) {
              for (const word of words) {
                if (title.includes(word) || body.includes(word)) {
                  labels.push(label);
                  console.log(`  ğŸ¯ æ ¹æ®å…³é”®è¯ "${word}" æ·»åŠ ä¼˜å…ˆçº§: ${label}`);
                  break;
                }
              }
              if (labels.some(l => l.startsWith('priority:'))) break;
            }

            // 4. æ£€æµ‹æ˜¯å¦éœ€è¦æ›´å¤šä¿¡æ¯
            if (body.length < 100 && !labels.includes('question')) {
              labels.push('needs more info');
              console.log('  â„¹ï¸  å†…å®¹è¾ƒçŸ­ï¼Œæ·»åŠ  "éœ€è¦æ›´å¤šä¿¡æ¯" æ ‡ç­¾');
            }

            // 5. æ£€æµ‹æ˜¯å¦æ˜¯å¥½çš„é¦–æ¬¡è´¡çŒ®è®®é¢˜
            const easyKeywords = ['ç®€å•', 'easy', 'å…¥é—¨', 'beginner', 'æ–°æ‰‹'];
            for (const word of easyKeywords) {
              if (title.includes(word) || body.includes(word)) {
                labels.push('good first issue');
                console.log('  ğŸ‘‹ æ£€æµ‹åˆ°é€‚åˆæ–°æ‰‹çš„è®®é¢˜');
                break;
              }
            }

            // 6. åº”ç”¨æ ‡ç­¾
            if (labels.length > 0) {
              const uniqueLabels = [...new Set(labels)];
              console.log(`\nâœ… å°†æ·»åŠ ä»¥ä¸‹æ ‡ç­¾: ${uniqueLabels.join(', ')}`);
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: uniqueLabels
              });

              console.log('âœ¨ æ ‡ç­¾æ·»åŠ æˆåŠŸï¼');
            } else {
              console.log('\nâ„¹ï¸  æœªæ£€æµ‹åˆ°åˆé€‚çš„æ ‡ç­¾');
            }

            // 7. æ·»åŠ æ¬¢è¿è¯„è®ºï¼ˆä»…é’ˆå¯¹æ–° Issueï¼‰
            if (context.payload.action === 'opened') {
              let comment = `ğŸ‘‹ æ„Ÿè°¢æäº¤ Issueï¼\n\n`;
              
              if (labels.includes('bug')) {
                comment += `æˆ‘ä»¬å·²ç»å°†æ­¤ Issue æ ‡è®°ä¸º **Bug**ã€‚æˆ‘ä»¬ä¼šå°½å¿«æŸ¥çœ‹å¹¶ä¿®å¤ã€‚\n\n`;
                comment += `ğŸ’¡ **æ¸©é¦¨æç¤º**: å¦‚æœå¯ä»¥ï¼Œè¯·æä¾›:\n`;
                comment += `- å¤ç°æ­¥éª¤\n`;
                comment += `- é¢„æœŸè¡Œä¸ºå’Œå®é™…è¡Œä¸º\n`;
                comment += `- ç›¸å…³çš„é”™è¯¯æ—¥å¿—æˆ–æˆªå›¾\n`;
              } else if (labels.includes('enhancement')) {
                comment += `æˆ‘ä»¬å·²ç»å°†æ­¤ Issue æ ‡è®°ä¸º **åŠŸèƒ½éœ€æ±‚**ã€‚æ„Ÿè°¢ä½ çš„å»ºè®®ï¼\n\n`;
                comment += `ğŸ’¡ **æ¸©é¦¨æç¤º**: è¯¦ç»†æè¿°ä½¿ç”¨åœºæ™¯ä¼šå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£ä½ çš„éœ€æ±‚ã€‚\n`;
              } else if (labels.includes('question')) {
                comment += `æˆ‘ä»¬å·²ç»å°†æ­¤ Issue æ ‡è®°ä¸º **é—®é¢˜å’¨è¯¢**ã€‚\n\n`;
                comment += `ğŸ’¡ **æ¸©é¦¨æç¤º**: è¯·æŸ¥çœ‹ [é¡¹ç›®æ–‡æ¡£](${issue.repository_url.replace('https://api.github.com/repos', 'https://github.com')}) çœ‹æ˜¯å¦æœ‰ç›¸å…³è¯´æ˜ã€‚\n`;
              }

              if (labels.includes('needs more info')) {
                comment += `\nâš ï¸ è¯·æä¾›æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¥½åœ°å¸®åŠ©ä½ ã€‚`;
              }

              comment += `\n---\n*æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµç”Ÿæˆ*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });

              console.log('ğŸ’¬ å·²æ·»åŠ æ¬¢è¿è¯„è®º');
            }

            console.log('\nğŸ‰ Issue åˆ†ç±»å®Œæˆï¼');